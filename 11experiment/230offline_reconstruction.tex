% !TEX root = ../main.tex
\subsubsection{Offline Reconstruction} \label{sssec::offlinereconstruction}
    CLAS12 reconstruction and analysis relies on a data-stream processing framework called CLARA.
    CLARA provides a service-oriented architecture in which to build software applications composed of micro-services, linked together by data-stream pipes.
    The service-oriented framework allows for each engine to be encapsulated, helping guarantee a long lifetime and code modularity \cite{gyurgyan2016}.

    A service receives input data, processes it, and produces output data, where the I/O is organised into tabular structures called ``banks'' whose structure is configured by the specific service developer.
    A service reacts to an input data stream, processes it, and passes processed data to the next service in the data-flow path.
    As a result, the CLAS12 data processing application is versatile and flexible, since the application building blocks can be improved individually and replaced with no need for structural changes in the framework.
    % The CLAS12 services are extensions of an abstract reconstruction engine, which includes common components such as initialisation and event processing methods.
    % This approach reduces and simplifies the development of an individual micro-service and enforces a common structure.

    Data reader services access the detector decoded data stored in banks.
    Each entry for the decoded detector hits is a row in a bank.
    A row includes detector element identifiers (sector, layer, component, and order), and digitised detector data, such as signal charge, amplitude, time, or pedestal, depending on the specific system.
    Similar bank structures are created at the decoding stage for the various quantities needed for event reconstruction, such as hits, clusters, tracks, etc.
    The services that implement the reconstruction algorithms pertaining to the CLAS12 subsystems fill these banks, which are subsequently appended and written out to a file by a data-persistence service.

    The services running the reconstruction algorithms access the various banks as input and produce output banks needed for the subsequent algorithms in the reconstruction chain.
    The order in which the services are chained reflects the overall CLAS12 event reconstruction sequence and subsystem dependencies.
    First, charged particle tracks are reconstructed in both the Central and Forward Detector tracking systems based on the position of the recorded hits in the different detectors (i.e. using strip positions or wire locations).
    This procedure is referred to as ``hit-based'' tracking.

    In parallel, hits recorded in the other detectors are processed to reconstruct the energy and time of the associated particle interaction.
    These are matched to the reconstructed tracks by the Event Builder (EB) service, based on hit
    position and time information.
    Unmatched hits are retained as neutral particle candidates.
    At this stage, the EB can reconstruct the event ``start time'', or the time of the interaction between the beam and target, and identify the reconstructed particles.
    Once the event start time is determined, a second iteration of forward tracking can be performed to implement the so-called ``time-based'' tracking, which also incorporates the drift times in the Drift Chambers \cite{ziegler2020}.

    An overview of the reconstruction application service composition detailing these dependencies is shown in Figure \ref{fig::recon_chain}.

    \begin{figure}[t]
        \centering\frame{
        \includegraphics[width=\textwidth]{11experiment/img/23recon_chain.pdf}}
        \caption[CLAS12 Reconstruction Chain.]{Graphical representation of the CLAS12 interdependencies between services and banks.
        The I/O service reads events from the input file and distributes them to the reconstruction services chain for processing.
        Each service reads the relevant banks, applies the reconstruction algorithm, and provides output banks that are passed to the next service in the chain.
        The Event Builder (EB) service is executed as last in the chain; it collects the relevant banks from all CLAS12 subsystems services and produces event, particle, and detector response banks that are written to the output file.}
        \label{fig::recon_chain}
    \end{figure}

    \input{11experiment/231tracking}
    \input{11experiment/232particle_identification}
