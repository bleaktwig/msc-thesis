% !TEX root = ../main.tex
\subsubsection{\texttt{make\_ntuples}}
\label{sssec::make_ntuples}
    This executable operates on one or more files generated by \texttt{hipo2root} and produces a ROOT file that contains a set of \texttt{ntuples} relevant to the analysis.
    Furthermore, based on the specific requirements of this thesis' analysis, the executable generates two sets of \texttt{ntuples}.
    Both sets have the same \texttt{ntuple} format, but the former utilises only DC tracking data while the latter incorporates both DC and FMT tracking data.

    \begin{table}
        \caption{Particle identification matrix for the FD.
        The rows show the PID assigned by reconstruction while the columns the one assigned by the \texttt{make\_ntuples} program.
        The diagonal elements are correctly identified, while the off-diagonal elements are misidentified.}

        \begin{center}
            \begin{tabularx}{240pt}{X|llllll}
                \cline{2-7}
                         & $e$      & $\pi$ & $K$  & $p$  & $n$  & $\gamma$ \\
                \hline
                $e$      & 1.00     &       &      &      &      &          \\
                $\pi$    &          & 1.00  & 0.09 & 0.02 &      &          \\
                $K$      &          &       & 0.91 &      &      &          \\
                $p$      &          &       &      & 0.98 &      &          \\
                $n$      &          &       &      &      & 1.00 &          \\
                $\gamma$ &          &       &      &      &      & 1.00     \\
                \hline
            \end{tabularx}
        \end{center}
        \label{tab::mpid}
    \end{table}

    For each event, the program executes the following algorithm:

    \begin{enumerate}
        \item
            First, the program identifies the TOF of the trigger electron.
            The hits of the trigger electron in the FD scintillators and FD calorimeters are listed in order of priority based on the precision of each detector's TOF measurement.
            The detectors are prioritised as follows: FTOF panel-1b (FTOF1B), FTOF panel-1a (FTOF1A), FTOF panel-2 (FTOF2), Pre-shower Calorimeter (PCAL), ECIN, and ECOU, as described in section \ref{sssec::forward_detector}.
            Next, the program iterates over the list of hits, extracting the TOF value from the earliest hit in the most precise available layer.

        \item
            Next, for each available track, two particle objects are instantiated.
            These objects contain the relevant data for the particle, including its vertex position, vertex momentum, charge, beta, and the CLAS12 sector through which it passed.
            The first object corresponds to the tracking data obtained from the DC, while the second object incorporates both the DC and the FMT tracking data.
            The assignment of the particle's PID will be carried out later in the process.

        \item
            The program computes and stores the particle's deposited energy in the calorimeters.
            This involves summing up the energy deposited by all the hits associated with the particle's track for each calorimeter.

        \item
            The program counts the number of produced photoelectrons in the HTCC and LTCC for the particle.
            Furthermore, the particle's TOF is computed using the same procedure as the one employed for the trigger electron's TOF, considering the hits in the detectors prioritised by their precision.

        \item
            The program assigns the Particle Identification (PID) to the particle.
            The process is very similar to the PID assignment in reconstruction, as described in section \ref{sssec::offline_reconstruction}.
            However, the assigned PID is not directly used in order to allow users to modify parameters and define new criteria for the PID assignment.

            Although this process typically yields the same results as reconstruction, there is a slight error in the PID assignment.
            This error is presented in table \ref{tab::mpid}.
            As shown in the table, some kaons and protons are misidentified as pions, but the degree of misidentification is not significant.
            Apart from that, all identifications are accurate.

        \item
            Finally, two \texttt{ntuples} objects are created: one for the particle generated from the DC tracking data and another for the particle generated from both the DC and FMT data.
            These \texttt{ntuple} objects are then saved in an output file, which can be used directly for analysis or processed by the \texttt{draw\_plots} program discussed in the next section.
    \end{enumerate}

    \pagebreak

    The manual entry of the program is:
    \begin{lstlisting}
Usage: make_ntuples [-hDf:cn:w:d:] infile
 * -h         : show this message and exit.
 * -D         : activate debug mode.
 * -f fmtlyrs : define how many FMT layers should the track have hit.
                Options are 0 (tracked only by DC), 2, and 3. If set to
                something other than 0 and there is no FMT::Tracks bank
                in the input file, the program will crash. Default is
                0.
 * -c         : apply FMT geometry cut on data.
 * -n nevents : number of events.
 * -w workdir : location where output root files are to be stored.
                Default is root_io.
 * -d datadir : location where sampling fraction files are. Default is
                data.
 * infile     : input ROOT file. Expected file format:
                <text>run_no.root`.

Generate ntuples relevant to SIDIS analysis based on the reconstructed variables from CLAS12 data. The output of the program is the `ntuples_<run_no>.root` file, which contains all relevant ntuples for RG-E analysis. This file can be studied directly in root or through the `draw_plots` program.
    \end{lstlisting}
